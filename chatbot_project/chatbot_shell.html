<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Cloud Chatbot</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #chatLog { width: 100%; height: 300px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .user { text-align: right; color: blue; }
        .bot { text-align: left; color: green; }
        input[type="text"] { width: 70%; padding: 8px; }
        button { padding: 8px; }
    </style>
</head>
<body>
    <h1>Chat with My AI</h1>
    <div id="chatLog"></div>
    <input type="text" id="userInput" placeholder="Type here...">
    <button onclick="sendMessage()">Send</button>

    <script>
        const chatLog = document.getElementById('chatLog');
        const userInput = document.getElementById('userInput');

        // THIS URL WILL BE THE URL OF YOUR DEPLOYED SERVERLESS FUNCTION
        const YOUR_SERVERLESS_PROXY_URL = 'REPLACE_WITH_YOUR_DEPLOYED_FUNCTION_URL';

        let conversationTurns = [
            // **YOUR AI STUDIO PROMPT AS THE FIRST TURN(S) - VERY IMPORTANT**
            // This structure MUST match what "Get Code" in AI Studio shows
            // for the 'contents' array's initial setup.
            // Example:
            { role: "user", parts: [{ text: "You are Pirate Pete. Talk like a pirate." }] },
            { role: "model", parts: [{ text: "Arrr, Captain! I be ready!" }] }
            // ---------------------------------------------------------------
        ];

        function appendToLog(message, type) {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = type;
            chatLog.appendChild(p);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText) return;

            appendToLog(`You: ${userText}`, 'user');
            userInput.value = ''; // Clear input

            // Add user's message to our turns
            conversationTurns.push({ role: "user", parts: [{ text: userText }] });

            try {
                const response = await fetch(YOUR_SERVERLESS_PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // We send the ENTIRE conversation history to the proxy
                    body: JSON.stringify({ conversation_history: conversationTurns })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    appendToLog(`Bot: Error - ${errorData.error || response.statusText}`, 'bot');
                    // Remove the last user message from history if the call failed, so they can retry
                    conversationTurns.pop();
                    return;
                }

                const data = await response.json(); // Expecting { "reply": "..." } from proxy
                appendToLog(`Bot: ${data.reply}`, 'bot');

                // Add bot's reply to our turns
                conversationTurns.push({ role: "model", parts: [{ text: data.reply }] });

            } catch (err) {
                appendToLog(`Bot: Network Error - ${err.message}`, 'bot');
                conversationTurns.pop(); // Remove last user message on error
            }
        }
        // Initial message from bot (optional, just UI)
        appendToLog('Bot: Ahoy! Type yer message below, matey!', 'bot');
    </script>
</body>
</html>